#+TITLE:     My Email Setup
#+AUTHOR:    Rubens.TS
#+EMAIL:     rubensts@gmail.com
#+DATE:      2016-08-18
#+LANGUAGE:  en
#+PROPERTY: header-args :comments org
#+OPTIONS: author:nil date:nil toc:nil title:nil e:nil
#+LaTeX_HEADER: \pagenumbering{gobble}
#+LaTeX_HEADER: \usepackage[T1]{fontenc}
#+LaTeX_HEADER: \usepackage{fontspec}
#+LaTeX_HEADER: \setmonofont[Scale=0.7]{DejaVu Sans Mono}
#+LaTeX_HEADER: \usepackage{mathpazo}
#+LaTeX_HEADER: \usepackage{geometry}
#+LaTeX_HEADER: \geometry{a4paper, margin=20mm}
#+LaTeX_HEADER: \usepackage{minted}
#+LaTeX_HEADER: \setminted{breaklines}

#+ATTR_LATEX: :width 5cm :align center :float t
#+ATTR_HTML: :width 110px

* About

This is the configuration for my email setup. It uses the following softwares:

- isync (mbsync): receives emails
- notmuch: query messages and also as as email front-end interface on Emacs
- afew: filters and tags messages
- mstmp: sends email

* Workflow

* Configuration

** isync (mbsync)



#+BEGIN_SRC shell :tangle ~/.mbsyncrc
#------------------------------------------------------------------------------
# Personal gmail account
#------------------------------------------------------------------------------
IMAPAccount gmail
Host imap.gmail.com
User rubensts@gmail.com
PassCmd "gpg2 -q --for-your-eyes-only --no-tty -d ~/.password-store/email/gmail.mbsync.gpg"
AuthMechs LOGIN
SSLType IMAPS
SSLVersions TLSv1.2
CertificateFile /etc/ssl/certs/ca-certificates.crt

# THEN WE SPECIFY THE LOCAL AND REMOTE STORAGE
# - THE REMOTE STORAGE IS WHERE WE GET THE MAIL FROM (E.G., THE
#   SPECIFICATION OF AN IMAP ACCOUNT)
# - THE LOCAL STORAGE IS WHERE WE STORE THE EMAIL ON OUR COMPUTER

# REMOTE STORAGE (USE THE IMAP ACCOUNT SPECIFIED ABOVE)
IMAPStore gmail-remote
Account gmail

# LOCAL STORAGE (CREATE DIRECTORIES with mkdir -p Maildir/gmail)
MaildirStore gmail-local
Path ~/Maildir/gmail/
Inbox ~/Maildir/gmail/inbox

# CONNECTIONS SPECIFY LINKS BETWEEN REMOTE AND LOCAL FOLDERS
#
# CONNECTIONS ARE SPECIFIED USING PATTERNS, WHICH MATCH REMOTE MAIl
# FOLDERS. SOME COMMONLY USED PATTERS INCLUDE:
#
# 1 "*" TO MATCH EVERYTHING
# 2 "!DIR" TO EXCLUDE "DIR"
# 3 "DIR" TO MATCH DIR
#
# FOR INSTANCE IN THE SPECIFICATION BELOW:
#
# gmail-inbox gets the folder INBOX, ARCHIVE, and everything under "ARCHIVE*"
# gmail-trash gets only the "[Gmail]/Trash" folder and stores it to the local "trash" folder

# Automatically create missing mailboxes, both locally and on the server
Create Both
# Permanently remove all messages [on the Master/Slave] marked for deletion
Expunge Both
# Save the synchronization state files in the relevant directory
SyncState *

Channel gmail-inbox
Master :gmail-remote:
Slave :gmail-local:
Patterns "INBOX"

#Channel gmail-classes
#Master :gmail-remote:"[Gmail]/Classes"
#Slave :gmail-local:classes

Channel gmail-drafts
Master :gmail-remote:"[Gmail]/Drafts"
Slave :gmail-local:drafts

Channel gmail-sent
Master :gmail-remote:"[Gmail]/Sent Mail"
Slave :gmail-local:sent

Channel gmail-trash
Master :gmail-remote:"[Gmail]/Trash"
Slave :gmail-local:trash

#------------------------------------------------------------------------------
# 2ndQuadrant account
#------------------------------------------------------------------------------
IMAPAccount 2ndQ
Host imap.gmail.com
User rubens.souza@2ndquadrant.it
PassCmd "gpg2 -q --for-your-eyes-only --no-tty -d ~/.password-store/2ndQ/gmail.mbsync.gpg"
AuthMechs LOGIN
SSLType IMAPS
SSLVersions TLSv1.2
CertificateFile /etc/ssl/certs/ca-certificates.crt

IMAPStore 2ndQ-remote
Account 2ndQ

MaildirStore 2ndQ-local
Path ~/Maildir/2ndQ/
Inbox ~/Maildir/2ndQ/inbox

Create Both
Expunge Both
SyncState *

Channel 2ndQ-inbox
Master :2ndQ-remote:
Slave :2ndQ-local:
Patterns "INBOX"

Channel 2ndQ-drafts
Master :2ndQ-remote:"[Gmail]/Drafts"
Slave :2ndQ-local:drafts

Channel 2ndQ-sent
Master :2ndQ-remote:"[Gmail]/Sent Mail"
Slave :2ndQ-local:sent

Channel 2ndQ-trash
Master :2ndQ-remote:"[Gmail]/Bin"
Slave :2ndQ-local:trash

# Groups put together channels, so that we can invoke mbsync on a group to sync
# all channels
#
# For instance: "mbsync -V gmail" gets (verbosily) mail from "gmail-inbox",
# "gmail-sent", and "gmail-trash"
Group gmail
Channel gmail-inbox
Channel gmail-classes
Channel gmail-drafts
Channel gmail-sent
Channel gmail-trash
Channel 2ndQ-inbox
Channel 2ndQ-drafts
Channel 2ndQ-sent
Channel 2ndQ-trash
#+END_SRC

** notmuch

#+BEGIN_SRC shell :tangle ~/.notmuch-config
# .notmuch-config - Configuration file for the notmuch mail system
#
# For more information about notmuch, see https://notmuchmail.org

# Database configuration
#
# The only value supported here is 'path' which should be the top-level
# directory where your mail currently exists and to where mail will be
# delivered in the future. Files should be individual email messages.
# Notmuch will store its database within a sub-directory of the path
# configured here named ".notmuch".
#
[database]
path=/home/rubens/Maildir

# User configuration
#
# Here is where you can let notmuch know how you would like to be
# addressed. Valid settings are
#
#	name		Your full name.
#	primary_email	Your primary email address.
#	other_email	A list (separated by ';') of other email addresses
#			at which you receive email.
#
# Notmuch will use the various email addresses configured here when
# formatting replies. It will avoid including your own addresses in the
# recipient list of replies, and will set the From address based on the
# address to which the original email was addressed.
#
[user]
name=Rubens Souza
primary_email=rubens.souza@2ndquadrant.it
other_email=rubensts@gmail.com;

# Configuration for "notmuch new"
#
# The following options are supported here:
#
#	tags	A list (separated by ';') of the tags that will be
#		added to all messages incorporated by "notmuch new".
#
#	ignore	A list (separated by ';') of file and directory names
#		that will not be searched for messages by "notmuch new".
#
#		NOTE: *Every* file/directory that goes by one of those
#		names will be ignored, independent of its depth/location
#		in the mail store.
#
[new]
#tags=unread;inbox;
tags=new
ignore=

# Search configuration
#
# The following option is supported here:
#
#	exclude_tags
#		A ;-separated list of tags that will be excluded from
#		search results by default.  Using an excluded tag in a
#		query will override that exclusion.
#
[search]
exclude_tags=deleted;spam;

# Maildir compatibility configuration
#
# The following option is supported here:
#
#	synchronize_flags      Valid values are true and false.
#
#	If true, then the following maildir flags (in message filenames)
#	will be synchronized with the corresponding notmuch tags:
#
#		Flag	Tag
#		----	-------
#		D	draft
#		F	flagged
#		P	passed
#		R	replied
#		S	unread (added when 'S' flag is not present)
#
#	The "notmuch new" command will notice flag changes in filenames
#	and update tags, while the "notmuch tag" and "notmuch restore"
#	commands will notice tag changes and update flags in filenames
#
[maildir]
synchronize_flags=true

# Cryptography related configuration
#
# The following option is supported here:
#
#	gpg_path
#		binary name or full path to invoke gpg.
#
[crypto]
gpg_path=gpg
#+END_SRC

*** notmuch post hook

Hooks that will call actions after =notmuch= runs. Usually is used to tag the
messages using =notmuch tag= commands or even calling =afew=. The hook file has
to be located at =~/Maildir/.notmuch/hooks/post-new=, so remember to tangle the
code block below.

#+BEGIN_SRC shell tangle: no
#!/bin/sh
$HOME/.local/bin/afew --tag --new
#+END_SRC


*** notmuch post hook *old one - whithout using afew*

In case of using this post-hook, remember that the file has to be executable.

#+BEGIN_SRC shell :tangle no
#!/usr/bin/env zsh

#local db_path="$(notmuch config get database.path)"

## Start tagging

# Separate personal and work emails
notmuch tag +personal -- path:"gmail/**"
notmuch tag +2ndQ -- path:"2ndQ/**"

## 2ndQuadrant filters

# Monitor (Nagios and Icinga)
notmuch tag +monitor +jobrapido -new -- tag:new and from:icinga@jobrapido.com
notmuch tag +monitor +nagios -new -- tag:new and from:nagios@support.2ndquadrant.com
notmuch tag +monitor +navionics -new -- tag:new and from:monitor@navionicsindia.com
notmuch tag +monitor +subito -new -- tag:new and from:nagios@mxx.subito.it

# Barman
notmuch tag +barman +webmaster -new -- tag:new and to:webmaster@pgbarman.org
notmuch tag +barman +jobrapido -new -- tag:new and from:daemon@jobrapido.com
notmuch tag +barman +navionics -new -- tag:new and from:backupngs@navionics.com
notmuch tag +barman +subito -new -- tag:new and from:barman@subito.it
notmuch tag +barman +root -new -- tag:new and from:root@2ndquadrant.it and subject:barman
notmuch tag +barman +sincos -new -- tag:new and from:barman@dr.com

# Support RT
notmuch tag +rt -new -- tag:new and from:support@2ndquadrant.com
notmuch tag +platinum -- tag:rt and subject:platinum-support
notmuch tag +24x7 -- tag:rt and subject:support and not tag:platinum
notmuch tag +rdba -- tag:rt and subject:rdba
notmuch tag +rt +developer -new -- tag:new and from:developer-support@2ndquadrant.com
notmuch tag +rt +onboard -new -- tag:new and from:onboarding@2ndquadrant.com

# Staff
notmuch tag +staff -new -- tag:new and to:staff@2ndquadrant.com

# Redmine - Italy
notmuch tag +redmine -new -- tag:new and from:redmine@2ndquadrant.it
notmuch tag +jobrapido -- tag:redmine and subject:jobrapido
notmuch tag +navionics -- tag:redmine and subject:navionics
notmuch tag +subito -- tag:redmine and subject:subito
notmuch tag +promedicus -- tag:redmine and subject:"pro medicus"
notmuch tag +tierra -- tag:redmine and subject:tierra

# Fail2ban
notmuch tag +fail2ban -new -- tag:new and from:fail2ban@

# Timelive
notmuch tag +timelive -new -- tag:new and from:TimeLive2ndQuadrant

# ITPug
notmuch tag +itpug -new -- tag:new and to:itpug-soci@lists.itpug.org


## Personal filters

# finally, retag all "new" messages to "inbox" and "unread"
notmuch tag +inbox +unread -new -- tag:new
#+END_SRC

** afew

#+BEGIN_SRC shell :tangle ~/.config/afew/config
  # global configuration
  [global]

  # This is the default filter chain
  [SpamFilter]
  #[ClassifyingFilter]
  [KillThreadsFilter]
  [ListMailsFilter]
  [ArchiveSentMailsFilter]

  ###########################################################
  # Work
  ###########################################################

  ## Barman
  [HeaderMatchingFilter.1]
  header = Subject
  pattern = \[(?P<project>[a-zA-Z]+)(|.it)\].*\bBarman
  tags = +barman;+{project};-new

  ## Support RT
  [HeaderMatchingFilter.2]
  header = X-RT-Ticket
  pattern = (?P<team>[a-zA-Z0-9]+)\.\bcom
  tags = +rt

  ### Classify RT/Github projects lists accordingly to queue
  [HeaderMatchingFilter.3]
  header = Subject
  pattern = \[.*\/(?P<queue>[a-zA-Z0-9]+).*\]
  tags = +{queue};-new

  ## Redmine
  [HeaderMatchingFilter.4]
  header = X-Redmine-Project
  pattern = (?!it)(?P<project>\b[a-zA-Z]+)
  tags = +redmine;+{project};-new

  ## Monitoring
  [HeaderMatchingFilter.5]
  header = From
  pattern = (icinga|nagios|monitor)
  tags = +monitor;-new

  ## Kanban
  [HeaderMatchingFilter.6]
  header = Subject
  pattern = (Report Kanban|Support Kanban)
  tags = +kanban;-new

  ## Fail2Ban
  [HeaderMatchingFilter.7]
  header = From
  pattern = (fail2ban@.*\.\b2ndquadrant\.it)
  tags = +fail2ban;-new

  ## ITPUG
  [HeaderMatchingFilter.8]
  header = From
  pattern = (itpug-soci)
  tags = +itpug;-new

  ###########################################################
  # Personal
  ###########################################################

  ## Quora
  [HeaderMatchingFilter.9]
  header = From
  pattern = (quora.com)
  tags = +quora;-new;-inbox

  ## Social
  [HeaderMatchingFilter.10]
  header = From
  pattern = (linkedin.com)
  tags = +social;-new;-inbox

  # Put lists out of inbox
  [HeaderMatchingFilter.11]
  header = List-Id
  pattern = <(?P<list_id>.*)>
  tags = -new;-inbox

  [InboxFilter]

  # Move mode rules
  # [MailMover]
  # folders = INBOX Junk
  # max_age = 15

  # # rules
  # INBOX = 'tag:spam':Junk 'NOT tag:inbox':Archive
  #Junk = 'NOT tag:spam AND tag:inbox':INBOX 'NOT tag:spam':Archive


  ## Clients

  #[Filter.1]
  #message = Jobrapido
  #query = 'from:jobrapido'
  #tags = +jobrapido;-new
  #
  #[Filter.2]
  #message = Navionics
  #query = 'from:navionics'
  #tags = +navionics;-new
  #
  #[Filter.3]
  #message = Subito
  #query = 'from:subito'
  #tags = +subito;-new
  #
  #[Filter.4]
  #message = Root
  #query = 'from:root'
  #tags = +root;-new
  #
  #  ## Monitoring
  #  [Filter.1]
  #  message = Monitoring
  #  query = 'from:icinga OR from:nagios OR from:monitor'
  #  tags = +monitor;-new

  #  [Filter.6]
  #  message = Barman
  #  query = 'from:barman or subject:barman'
  #  tags = +barman;-new
  #
  ## Kanban

  #[Filter.7]
  #message = Kanban
  #query = 'subject:"24x7 Support Kanban Board"'
  #tags = +kanban;-new
  #
  #  [Filter.8]
  #  message = Support RT - Platinum
  #  query = 'subject:/platinum'
  #  tags = +platinum;-new
  #
  #  [Filter.9]
  #  message = Support RT - 24x7
  #  query = 'subject:/support'
  #  tags = +24x7;-new
  #
  #(\[[a-zA-Z]\w+\/\bsupport)
  #
  #  [Filter.10]
  #  message = Support RT - RDBA
  #  query = 'subject:/rdba'
  #  tags = +rdba;-new
  #
  #  [Filter.11]
  #  message = Support RT - Developer
  #  query = 'from:developer-support@2ndquadrant.com'
  #  tags = +developer;-new
  #
  #  [Filter.12]
  #  message = Support RT - Onboarding
  #  query = 'from:onboarding@2ndquadrant.com'
  #  tags = +onboard;-new
  #
  ## Redmine
  #[Filter.13]
  #message = Redmine
  #query = 'from:redmine'
  #tags = +redmine;-new

  ### ITPUG
  #[Filter.14]
  #message = ITPUG Mailing List
  #query = 'subject:itpug'
  #tags = +itpug;-new

  ### Fail2ban
  #[Filter.15]
  #message = Fail2ban 2ndQ
  #query = 'from:fail2ban@ironman.2ndquadrant.it'
  #tags = +fail2ban2ndQ;-new

#+END_SRC

** msmtp
